<!-- START OF FILE ai_studio_code (44).html -->

<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprite Slicer Pro - Precision Grid</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* --- 基础变量 --- */
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --surface: #1e293b;
            --background: #0f172a;
            --border: #334155;
            --input-bg: #0f172a;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --line-color: rgba(100, 116, 139, 0.8); 
            --line-active: #ffffff;
            --line-shadow: #6366f1;
        }

        [data-theme="light"] {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --surface: #ffffff;
            --background: #f8fafc;
            --border: #e2e8f0;
            --input-bg: #f1f5f9;
            --text-main: #334155;
            --text-sub: #64748b;
            --line-color: rgba(255, 255, 255, 0.9);
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; background-color: var(--background); color: var(--text-main);
            height: 100vh; display: flex; flex-direction: column;
        }

        /* --- 布局样式 --- */
        header {
            background: var(--surface); padding: 15px 30px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .brand { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; gap: 10px; }
        .brand span { color: var(--text-main); }
        .theme-toggle {
            background: transparent; border: 1px solid var(--border); color: var(--text-main);
            padding: 6px 10px; border-radius: 6px; cursor: pointer; display: flex; gap: 5px; font-size: 12px;
        }

        .main-layout { display: grid; grid-template-columns: 340px 1fr; height: calc(100vh - 65px); overflow: hidden; }
        
        .sidebar {
            background: var(--surface); border-right: 1px solid var(--border);
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px;
        }
        .panel-section { display: flex; flex-direction: column; gap: 12px; }
        .section-title { font-size: 12px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; }

        input[type="number"], input[type="text"] {
            width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
            background: var(--input-bg); color: var(--text-main); font-size: 14px;
        }

        /* --- 文件上传区域 --- */
        .file-drop-area {
            border: 2px dashed var(--border); border-radius: 12px; padding: 30px 20px;
            text-align: center; cursor: pointer; background: var(--input-bg); transition: 0.2s;
            display: block; 
        }
        .file-drop-area:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }
        .file-drop-area input[type="file"] { display: none; }
        
        .file-icon { width: 32px; height: 32px; fill: var(--primary); margin-bottom: 8px; }
        .file-msg { font-size: 13px; color: var(--text-sub); line-height: 1.5; }
        .file-msg kbd {
            background: var(--surface); border: 1px solid var(--border); border-radius: 4px;
            padding: 2px 4px; font-family: monospace; font-size: 11px; color: var(--text-main);
        }

        .input-group-row { display: grid; grid-template-columns: 1fr 20px 1fr; align-items: center; gap: 5px; }
        .input-group-row span { text-align: center; color: var(--text-sub); }

        .trim-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; }
        .trim-item { display: flex; align-items: center; gap: 8px; }
        .trim-item label { font-size: 12px; color: var(--text-sub); width: 20px; }

        .bg-card { background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; }
        .toggle-switch { display: flex; justify-content: space-between; cursor: pointer; margin-bottom: 12px; align-items: center; }
        .toggle-track { width: 40px; height: 22px; background: var(--border); border-radius: 20px; position: relative; transition: 0.3s; }
        .toggle-track::after { content:''; position:absolute; top:2px; left:2px; width:18px; height:18px; background:#fff; border-radius:50%; transition:0.3s; }
        input:checked + .toggle-track { background: var(--primary); }
        input:checked + .toggle-track::after { transform: translateX(18px); }

        .color-tools { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .color-preview-btn { width: 36px; height: 36px; border-radius: 6px; border: 2px solid #fff; position: relative; overflow: hidden;}
        input[type="color"] { position: absolute; top:-50%; left:-50%; width:200%; height:200%; opacity:0; cursor: pointer; }
        .tool-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; background: var(--surface); border: 1px solid var(--border); padding: 8px; border-radius: 6px; cursor: pointer; color: var(--text-main); }
        .tool-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; color: #fff; }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
        .btn-secondary { background: #8b5cf6; }
        .btn-secondary:hover:not(:disabled) { background: #7c3aed; }
        .btn:disabled { background: var(--border); opacity: 0.5; cursor: not-allowed; }

        /* --- 右侧画布区域 --- */
        .workspace {
            background: #000; padding: 40px; overflow: auto; display: flex; justify-content: center; align-items: center;
            background-image: radial-gradient(var(--border) 1px, transparent 1px); background-size: 20px 20px;
        }
        [data-theme="light"] .workspace { background: #e2e8f0; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); }

        .canvas-container {
            position: relative;
            background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%);
            background-size: 16px 16px; background-color: #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        [data-theme="light"] .canvas-container { background-color: #fff; background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); }

        canvas { display: block; max-width: 100%; pointer-events: none; }

        /* --- 分割线 --- */
        #linesOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        .split-line {
            position: absolute;
            background-color: transparent;
            pointer-events: auto;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .split-line::after {
            content: '';
            position: absolute;
            background-color: var(--line-color);
            transition: all 0.2s;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .split-line:hover::after, .split-line.dragging::after {
            background-color: var(--line-active);
            box-shadow: 0 0 6px var(--line-shadow);
        }

        .split-line-v { top: 0; bottom: 0; width: 10px; margin-left: -5px; cursor: col-resize; }
        .split-line-v::after { width: 1px; height: 100%; }
        .split-line-v:hover::after, .split-line-v.dragging::after { width: 2px; }

        .split-line-h { left: 0; right: 0; height: 10px; margin-top: -5px; cursor: row-resize; }
        .split-line-h::after { width: 100%; height: 1px; }
        .split-line-h:hover::after, .split-line-h.dragging::after { height: 2px; }

        /* 单元格交互 */
        #cellsOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        .cell-hitbox {
            position: absolute; pointer-events: auto;
        }
        .cell-hitbox:hover {
            box-shadow: inset 0 0 0 1px var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .cell-actions {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; gap: 5px; opacity: 0; pointer-events: none; transition: 0.2s;
            background: rgba(0,0,0,0.7); padding: 4px; border-radius: 6px; white-space: nowrap;
        }
        .cell-hitbox:hover .cell-actions { opacity: 1; pointer-events: auto; }

        .mini-btn {
            width: 28px; height: 28px; border: none; border-radius: 4px; background: var(--surface); color: var(--text-main);
            display: inline-flex; align-items: center; justify-content: center; cursor: pointer; vertical-align: middle;
        }
        .mini-btn:hover { background: var(--primary); color: #fff; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--surface); padding: 20px; border-radius: 12px; max-width: 90%; max-height: 90%;
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-img-box {
            background: #fff; background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px; border-radius: 8px; overflow: auto; display: flex; justify-content: center;
        }
        #modalImg { max-width: 100%; max-height: 70vh; }

        #status-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--surface); color: var(--text-main); padding: 10px 20px; border-radius: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 2000; display: none;
            border: 1px solid var(--border); font-size: 14px;
        }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentColor" d="M19,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M5,19V5H19V19H5M7,7H17V9H7V7M7,11H17V13H7V11M7,15H17V17H7V15Z" /></svg>
        Sprite <span>Slicer</span>
    </div>
    <button id="themeToggle" class="theme-toggle">
        <svg style="width:16px;height:16px" viewBox="0 0 24 24"><path fill="currentColor" d="M12,18C11.11,18 10.26,17.8 9.5,17.45C11.56,16.5 13,14.42 13,12C13,9.58 11.56,7.5 9.5,6.55C10.26,6.2 11.11,6 12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31L23.31,12L20,8.69Z" /></svg>
        主题
    </button>
</header>

<div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="panel-section">
            <div class="section-title">1. 图片源</div>
            <label class="file-drop-area">
                <input type="file" id="imageUpload" accept="image/*">
                <svg class="file-icon" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13.5,16V19H10.5V16H8L12,12L16,16H13.5M13,9V3.5L18.5,9H13Z" /></svg>
                <div class="file-msg" id="fileMsg">
                    点击 / 拖拽 / <kbd>Ctrl+V</kbd><br>上传图片
                </div>
            </label>
        </div>

        <div class="panel-section">
            <div class="section-title">2. 网格初始设置</div>
            <p style="font-size:12px; color:var(--text-sub); margin:0;">拖拽右侧<strong>细线</strong>可调整切割位置。</p>
            <div class="input-group-row">
                <div><label>列数 (Col)</label><input type="number" id="cols" value="4" min="1"></div>
                <span style="padding-top:20px">×</span>
                <div><label>行数 (Row)</label><input type="number" id="rows" value="4" min="1"></div>
            </div>
            <button id="resetGridBtn" class="btn btn-secondary" style="padding:6px; font-size:12px;">重置为均分网格</button>
        </div>

        <div class="panel-section">
            <div class="section-title">3. 边缘修剪 (px)</div>
            <div class="trim-grid">
                <div class="trim-item"><label>上</label><input type="number" id="eraseTop" value="0"></div>
                <div class="trim-item"><label>下</label><input type="number" id="eraseBottom" value="0"></div>
                <div class="trim-item"><label>左</label><input type="number" id="eraseLeft" value="0"></div>
                <div class="trim-item"><label>右</label><input type="number" id="eraseRight" value="0"></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title">4. 智能去背</div>
            <div class="bg-card">
                <label class="toggle-switch">
                    <span style="font-size:14px;">启用去背</span>
                    <input type="checkbox" id="removeBgCheck" style="display:none">
                    <div class="toggle-track"></div>
                </label>
                <div id="bgSettings" style="opacity:0.5; pointer-events:none; transition:0.3s;">
                    <div class="color-tools">
                        <div class="color-preview-btn" style="background:#000" id="colorPreviewBox">
                            <input type="color" id="bgColorPicker" value="#000000">
                        </div>
                        <span id="hexValue" style="font-family:monospace; font-size:12px;">#000000</span>
                        <button id="eyedropperBtn" class="tool-btn">
                            <svg style="width:16px;height:16px" viewBox="0 0 24 24"><path fill="currentColor" d="M19.35,11.72L17.22,13.85L15.81,12.43L8.1,20.14L3.5,22L2,20.5L3.86,15.9L11.57,8.19L10.15,6.78L12.28,4.65L19.35,11.72M16.76,3L5,14.76L9.24,19L21,7.24L16.76,3Z" /></svg> 吸色
                        </button>
                    </div>
                    <label style="font-size:12px;">容差: <span id="threshDisp">30</span></label>
                    <input type="range" id="threshRange" min="0" max="200" value="30" style="width:100%">
                </div>
            </div>
        </div>

        <div class="action-bar" style="margin-top:auto">
            <button id="dlZipBtn" class="btn btn-primary" disabled>
                <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor"><path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" /></svg>
                打包下载所有切片 (ZIP)
            </button>
        </div>
    </aside>

    <!-- Workspace -->
    <main class="workspace" id="workspace">
        <div id="emptyState" style="text-align:center; color:var(--text-sub);">
            <svg style="width:64px;height:64px;fill:var(--border)" viewBox="0 0 24 24"><path d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z" /></svg>
            <p>请上传一张图片开始<br><span style="font-size:12px;opacity:0.6">支持 Ctrl+V 粘贴</span></p>
        </div>

        <div class="canvas-container" id="imgWrapper" style="display:none;">
            <canvas id="mainCanvas"></canvas>
            <div id="linesOverlay"></div>
            <div id="cellsOverlay"></div>
        </div>
    </main>
</div>

<!-- Modal & Toast -->
<div id="viewModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between;">
            <span style="font-weight:bold;">预览</span>
            <button onclick="document.getElementById('viewModal').style.display='none'" style="background:none; border:none; color:var(--text-main); font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-img-box"><img id="modalImg" src=""></div>
        <button id="modalDlBtn" class="btn btn-primary" style="width:auto; align-self:flex-end;">下载此图</button>
    </div>
</div>
<div id="status-toast"></div>

<script>
    const els = {
        upload: document.getElementById('imageUpload'),
        canvas: document.getElementById('mainCanvas'),
        wrapper: document.getElementById('imgWrapper'),
        empty: document.getElementById('emptyState'),
        linesOverlay: document.getElementById('linesOverlay'),
        cellsOverlay: document.getElementById('cellsOverlay'),
        rows: document.getElementById('rows'),
        cols: document.getElementById('cols'),
        resetBtn: document.getElementById('resetGridBtn'),
        zipBtn: document.getElementById('dlZipBtn'),
        bgCheck: document.getElementById('removeBgCheck'),
        bgSettings: document.getElementById('bgSettings'),
        bgPicker: document.getElementById('bgColorPicker'),
        bgBox: document.getElementById('colorPreviewBox'),
        hex: document.getElementById('hexValue'),
        eyeBtn: document.getElementById('eyedropperBtn'),
        thresh: document.getElementById('threshRange'),
        threshDisp: document.getElementById('threshDisp'),
        theme: document.getElementById('themeToggle'),
        inputs: ['eraseTop', 'eraseBottom', 'eraseLeft', 'eraseRight'].map(id => document.getElementById(id))
    };

    let state = {
        img: null,
        naturalW: 0,
        naturalH: 0,
        gridX: [], 
        gridY: [],
        bgColor: [0,0,0],
        picking: false,
        dragging: null,
        theme: 'dark'
    };

    // --- 文件加载核心逻辑 (支持 Input 和 Paste) ---
    function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) return;
        
        const reader = new FileReader();
        reader.onload = evt => {
            state.img = new Image();
            state.img.onload = () => {
                state.naturalW = state.img.naturalWidth;
                state.naturalH = state.img.naturalHeight;
                els.canvas.width = state.naturalW;
                els.canvas.height = state.naturalH;
                
                els.empty.style.display = 'none';
                els.wrapper.style.display = 'block';
                els.zipBtn.disabled = false;

                initGridData();
                renderAll();
                
                document.getElementById('fileMsg').innerHTML = file.name;
            };
            state.img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    }

    // 1. Input Change 事件
    els.upload.addEventListener('change', e => {
        handleFile(e.target.files[0]);
    });

    // 2. 全局 Paste 事件
    document.addEventListener('paste', e => {
        const items = e.clipboardData?.items;
        if (!items) return;
        
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const file = items[i].getAsFile();
                handleFile(file);
                showToast('已从剪贴板加载图片');
                break;
            }
        }
    });

    function initGridData() {
        if (!state.img) return;
        const r = parseInt(els.rows.value) || 1;
        const c = parseInt(els.cols.value) || 1;
        
        state.gridX = [];
        state.gridY = [];

        for (let i = 0; i <= c; i++) {
            state.gridX.push((state.naturalW / c) * i);
        }
        for (let i = 0; i <= r; i++) {
            state.gridY.push((state.naturalH / r) * i);
        }
    }

    function renderUI() {
        els.linesOverlay.innerHTML = '';
        els.cellsOverlay.innerHTML = '';
        if (!state.img) return;

        // Render Vertical Lines
        for (let i = 1; i < state.gridX.length - 1; i++) {
            const div = document.createElement('div');
            div.className = 'split-line split-line-v';
            const pct = (state.gridX[i] / state.naturalW) * 100;
            div.style.left = `${pct}%`;
            div.addEventListener('mousedown', (e) => startDrag(e, 'x', i));
            els.linesOverlay.appendChild(div);
        }

        // Render Horizontal Lines
        for (let i = 1; i < state.gridY.length - 1; i++) {
            const div = document.createElement('div');
            div.className = 'split-line split-line-h';
            const pct = (state.gridY[i] / state.naturalH) * 100;
            div.style.top = `${pct}%`;
            div.addEventListener('mousedown', (e) => startDrag(e, 'y', i));
            els.linesOverlay.appendChild(div);
        }

        // Render Cells Hitboxes
        for (let r = 0; r < state.gridY.length - 1; r++) {
            for (let c = 0; c < state.gridX.length - 1; c++) {
                const x = state.gridX[c];
                const y = state.gridY[r];
                const w = state.gridX[c+1] - x;
                const h = state.gridY[r+1] - y;

                const cell = document.createElement('div');
                cell.className = 'cell-hitbox';
                cell.style.left = (x / state.naturalW * 100) + '%';
                cell.style.top = (y / state.naturalH * 100) + '%';
                cell.style.width = (w / state.naturalW * 100) + '%';
                cell.style.height = (h / state.naturalH * 100) + '%';

                cell.addEventListener('click', (e) => {
                    if (state.picking) {
                        e.stopPropagation();
                        const rect = els.linesOverlay.getBoundingClientRect();
                        const clickX = (e.clientX - rect.left) * (state.naturalW / rect.width);
                        const clickY = (e.clientY - rect.top) * (state.naturalH / rect.height);
                        pickColor(clickX, clickY);
                    }
                });

                const actions = document.createElement('div');
                actions.className = 'cell-actions';
                
                // 1. View Button
                const btnView = document.createElement('button');
                btnView.className = 'mini-btn';
                btnView.title = "预览";
                btnView.innerHTML = '<svg viewBox="0 0 24 24" style="width:16px"><path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>';
                btnView.onclick = () => viewCell(r, c);

                // 2. Copy Button (New)
                const btnCopy = document.createElement('button');
                btnCopy.className = 'mini-btn';
                btnCopy.title = "复制";
                btnCopy.innerHTML = '<svg viewBox="0 0 24 24" style="width:16px"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg>';
                btnCopy.onclick = () => copyCell(r, c);

                // 3. Download Button
                const btnDl = document.createElement('button');
                btnDl.className = 'mini-btn';
                btnDl.title = "下载";
                btnDl.innerHTML = '<svg viewBox="0 0 24 24" style="width:16px"><path fill="currentColor" d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/></svg>';
                btnDl.onclick = () => downloadCell(r, c);

                actions.appendChild(btnView);
                actions.appendChild(btnCopy);
                actions.appendChild(btnDl);
                cell.appendChild(actions);
                els.cellsOverlay.appendChild(cell);
            }
        }
    }

    function renderCanvas() {
        if (!state.img) return;
        const ctx = els.canvas.getContext('2d', { willReadFrequently: true });
        ctx.clearRect(0, 0, state.naturalW, state.naturalH);
        
        ctx.drawImage(state.img, 0, 0);

        const [t, b, l, r_pad] = els.inputs.map(i => parseInt(i.value) || 0);
        const removeBg = els.bgCheck.checked;
        const thresh = parseInt(els.thresh.value);
        const [tr, tg, tb] = state.bgColor;

        if (t || b || l || r_pad) {
            for (let rIdx = 0; rIdx < state.gridY.length - 1; rIdx++) {
                for (let cIdx = 0; cIdx < state.gridX.length - 1; cIdx++) {
                    const cx = state.gridX[cIdx];
                    const cy = state.gridY[rIdx];
                    const cw = state.gridX[cIdx+1] - cx;
                    const ch = state.gridY[rIdx+1] - cy;

                    if (t) ctx.clearRect(cx, cy, cw, t);
                    if (b) ctx.clearRect(cx, cy + ch - b, cw, b);
                    if (l) ctx.clearRect(cx, cy, l, ch);
                    if (r_pad) ctx.clearRect(cx + cw - r_pad, cy, r_pad, ch);
                }
            }
        }

        if (removeBg) {
            const frame = ctx.getImageData(0, 0, state.naturalW, state.naturalH);
            const d = frame.data;
            for (let i = 0; i < d.length; i += 4) {
                if (d[i+3] === 0) continue;
                const dist = Math.sqrt((d[i]-tr)**2 + (d[i+1]-tg)**2 + (d[i+2]-tb)**2);
                if (dist < thresh) d[i+3] = 0;
            }
            ctx.putImageData(frame, 0, 0);
        }
    }

    function renderAll() {
        renderCanvas();
        renderUI();
    }

    function startDrag(e, axis, index) {
        e.preventDefault();
        e.stopPropagation();
        state.dragging = { axis, index };
        document.body.style.cursor = axis === 'x' ? 'col-resize' : 'row-resize';
        els.cellsOverlay.style.pointerEvents = 'none';
        window.addEventListener('mousemove', onDrag);
        window.addEventListener('mouseup', stopDrag);
    }

    function onDrag(e) {
        if (!state.dragging) return;
        const rect = els.linesOverlay.getBoundingClientRect();
        const { axis, index } = state.dragging;
        let min, max;
        
        if (axis === 'x') {
            const relativeX = e.clientX - rect.left;
            const pixelX = relativeX * (state.naturalW / rect.width);
            min = state.gridX[index - 1] + 2;
            max = state.gridX[index + 1] - 2;
            state.gridX[index] = Math.max(min, Math.min(max, pixelX));
        } else {
            const relativeY = e.clientY - rect.top;
            const pixelY = relativeY * (state.naturalH / rect.height);
            min = state.gridY[index - 1] + 2;
            max = state.gridY[index + 1] - 2;
            state.gridY[index] = Math.max(min, Math.min(max, pixelY));
        }
        renderUI();
    }

    function stopDrag() {
        state.dragging = null;
        document.body.style.cursor = '';
        els.cellsOverlay.style.pointerEvents = 'none';
        window.removeEventListener('mousemove', onDrag);
        window.removeEventListener('mouseup', stopDrag);
        renderCanvas();
        renderUI();
    }

    els.resetBtn.onclick = () => { initGridData(); renderAll(); };
    
    let timer;
    const debouncedRender = () => { clearTimeout(timer); timer = setTimeout(renderCanvas, 50); };
    
    els.inputs.forEach(el => el.addEventListener('input', debouncedRender));
    els.bgCheck.addEventListener('change', function() {
        els.bgSettings.style.opacity = this.checked ? '1' : '0.5';
        els.bgSettings.style.pointerEvents = this.checked ? 'auto' : 'none';
        if (!this.checked && state.picking) toggleEyeDropper();
        renderCanvas();
    });
    els.thresh.addEventListener('input', function() {
        els.threshDisp.textContent = this.value;
        debouncedRender();
    });
    
    els.bgPicker.addEventListener('input', function() {
        const hex = this.value;
        els.bgBox.style.background = hex;
        els.hex.textContent = hex.toUpperCase();
        state.bgColor = hexToRgb(hex);
        renderCanvas();
    });

    els.eyeBtn.onclick = toggleEyeDropper;
    function toggleEyeDropper() {
        state.picking = !state.picking;
        els.eyeBtn.classList.toggle('active', state.picking);
        const hitboxes = document.querySelectorAll('.cell-hitbox');
        hitboxes.forEach(el => el.style.cursor = state.picking ? 'crosshair' : 'default');
    }

    function pickColor(x, y) {
        const ctx = document.createElement('canvas').getContext('2d');
        ctx.drawImage(state.img, x, y, 1, 1, 0, 0, 1, 1);
        const p = ctx.getImageData(0,0,1,1).data;
        const hex = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);
        state.bgColor = [p[0], p[1], p[2]];
        els.bgPicker.value = hex;
        els.bgBox.style.background = hex;
        els.hex.textContent = hex.toUpperCase();
        toggleEyeDropper();
        renderCanvas();
    }

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [0,0,0];
    }

    function getSliceBlob(r, c) {
        const x = state.gridX[c];
        const y = state.gridY[r];
        const w = state.gridX[c+1] - x;
        const h = state.gridY[r+1] - y;
        const tmp = document.createElement('canvas');
        tmp.width = w; tmp.height = h;
        tmp.getContext('2d').drawImage(els.canvas, x, y, w, h, 0, 0, w, h);
        return new Promise(resolve => tmp.toBlob(resolve));
    }

    window.viewCell = async (r, c) => {
        const blob = await getSliceBlob(r, c);
        const url = URL.createObjectURL(blob);
        document.getElementById('modalImg').src = url;
        document.getElementById('viewModal').style.display = 'flex';
        document.getElementById('modalDlBtn').onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = `slice_${r+1}_${c+1}.png`;
            a.click();
        };
    };

    // --- 新增: 复制功能 ---
    window.copyCell = async (r, c) => {
        try {
            const blob = await getSliceBlob(r, c);
            const item = new ClipboardItem({ [blob.type]: blob });
            await navigator.clipboard.write([item]);
            showToast('已复制到剪贴板');
        } catch (err) {
            console.error(err);
            showToast('复制失败: 浏览器不支持');
        }
    };

    window.downloadCell = async (r, c) => {
        const blob = await getSliceBlob(r, c);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `slice_${r+1}_${c+1}.png`;
        a.click();
    };

    els.zipBtn.onclick = async () => {
        if (!state.img) return;
        
        els.zipBtn.disabled = true;
        els.zipBtn.innerHTML = '<svg class="animate-spin" viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor;animation:spin 1s linear infinite"><path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/></svg> 打包处理中...';
        
        const zip = new JSZip();
        let count = 0;
        const rows = state.gridY.length - 1;
        const cols = state.gridX.length - 1;

        setTimeout(async () => {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const blob = await getSliceBlob(r, c);
                    zip.file(`slice_${r+1}_${c+1}.png`, blob);
                    count++;
                }
            }

            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = "sprites_custom.zip";
            a.click();

            els.zipBtn.disabled = false;
            els.zipBtn.innerHTML = '<svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor"><path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" /></svg> 打包下载所有切片 (ZIP)';
            showToast(`已下载 ${count} 个切片`);
        }, 100);
    };

    function showToast(msg) {
        const t = document.getElementById('status-toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(()=>t.style.display='none', 3000);
    }

    els.theme.onclick = () => {
        state.theme = state.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', state.theme);
    };
</script>
</body>
</html>